---
id: 1
published: true
title: "React hooks åœ¨useä»€éº¼(Part 1) - useState, useEffect"
createdAt: '2022-06-06'
updatedAt: '2022-06-06'
tags: ['React', 'React hooks', 'useState', 'useEffect']
headImg: '/posts/2022-06-06-react-hooks-part1/react-hook.png'
excerpt: "useStateã€useEffectåŸºæœ¬ç”¨æ³•ä¸¦é¿å…Infinite loopã€‚React è‡ªå¾ 16.8 ä¹‹å¾ŒåŠ å…¥äº† hook é€™å€‹æ–°åŠŸèƒ½ï¼Œè€Œ hook çš„ç›®çš„å°±æ˜¯è®“é–‹ç™¼è€…ä¸å¿…å¯« class å°±èƒ½ä½¿ç”¨ state ä»¥åŠå…¶ä»– React çš„åŠŸèƒ½ï¼Œå…¶å¯¦é€™å°±è·Ÿç¾åœ¨ Vue3 çš„ Composition API æ¦‚å¿µä¸€æ¨£ï¼Œæˆ‘å€‘åªéœ€è¦ import é€™äº› API å°±å¯ä»¥åœ¨ Function components ä¸­åšä½¿ç”¨ï¼Œç”šè‡³å®Œæˆ life cycle ä¸Šçš„å·¥ä½œã€‚"
---

<Image
    src="/posts/2022-06-06-react-hooks-part1/react-hook.png"
    alt="React hooks åœ¨useä»€éº¼(Part 1)"
/>

## å‰è¨€ âœ¨

React è‡ªå¾ 16.8 ä¹‹å¾ŒåŠ å…¥äº† hook é€™å€‹æ–°åŠŸèƒ½ï¼Œè€Œ hook çš„ç›®çš„å°±æ˜¯è®“é–‹ç™¼è€…ä¸å¿…å¯« class å°±èƒ½ä½¿ç”¨ state ä»¥åŠå…¶ä»– React çš„åŠŸèƒ½ï¼Œå…¶å¯¦é€™å°±è·Ÿç¾åœ¨ Vue3 çš„ Composition API æ¦‚å¿µä¸€æ¨£ï¼Œæˆ‘å€‘åªéœ€è¦ import é€™äº› API å°±å¯ä»¥åœ¨ Function components ä¸­åšä½¿ç”¨ï¼Œç”šè‡³å®Œæˆ life cycle ä¸Šçš„å·¥ä½œã€‚

é‚£éº¼åœ¨é€²å…¥æ­£æ–‡ä¸­ï¼Œæœƒå¸Œæœ›å¤§å®¶å¯ä»¥å°æ–¼ React 16 ä¹‹å¾Œçš„æ”¹å‹•æœ‰åŸºæœ¬çš„èªè­˜

é€™è£¡æ¨è–¦é€™ç¯‡æ–‡ç«  - [React é–‹ç™¼è€…ä¸€å®šè¦çŸ¥é“çš„åº•å±¤æ©Ÿåˆ¶ â€” React Fiber Reconciler]( https://medium.com/starbugs/react-%E9%96%8B%E7%99%BC%E8%80%85%E4%B8%80%E5%AE%9A%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%BA%95%E5%B1%A4%E6%9E%B6%E6%A7%8B-react-fiber-c3ccd3b047a1)

---

## Hook çš„è¦å‰‡

å…¶å¯¦ Hook å°±æ˜¯ Javascript çš„ functionï¼Œè€Œæœ‰å…©é»éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯

<Quote
    type={'warning'}
>
    ### æˆ‘å€‘åªåœ¨æœ€ä¸Šå±¤å‘¼å« Hook
    - **ä¸è¦åœ¨è¿´åœˆã€æ¢ä»¶å¼æˆ–æ˜¯å·¢ç‹€çš„ function å…§å‘¼å« Hook**
</Quote>

é€™è£¡æœ‰å€‹éŒ¯èª¤çš„ç¯„ä¾‹

<Code
    text={'é€™æ˜¯éŒ¯çš„!!'}
    type={'error'}
>
  ```javascript
  if (condition) {
    useEffect(() => {
      fetchData()
    }, []);
  }
  ```
</Code>
å¦‚æœæˆ‘å€‘é€™æ¨£æ‰“çš„è©± React æœƒç›´æ¥å ±éŒ¯ï¼Œé‚£æ˜¯å› ç‚º React çš„ Hook åœ¨ render æ™‚è¢«å‘¼å«çš„é †åºæ˜¯ä¸€è‡´çš„ï¼ŒReact å¯ä»¥å°‡ä¸€äº› local state å’Œå½¼æ­¤è¯ç¹«åœ¨ä¸€èµ·ã€‚

**é€™æ™‚å€™ React æœƒå› ç‚ºå°‘äº†å…¶ä¸­ä¸€å€‹æ­¥é©Ÿè€Œç™¼ç”Ÿ bug!!**

<Code
    text={'é€™æ˜¯å°çš„'}
    type={'success'}
>
    ```javascript
    useEffect(() => {
      if (condition) fetchData()
    }, []);
    ```
</Code>
<Quote
    type={'success'}
>
    - åœ¨ä»»ä½• early return ä¹‹å‰ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ React çš„ function component ä¸­çš„æœ€ä¸Šå±¤ä½¿ç”¨ Hookã€‚
    - è—‰ç”±éµå¾ªé€™äº›è¦å‰‡ï¼Œä½ å¯ä»¥ç¢ºä¿ç•¶æ¯æ¬¡ä¸€å€‹ component render æ™‚ Hook éƒ½ä¾ç…§æ­£ç¢ºçš„é †åºè¢«å‘¼å«ã€‚

    - React çš„å®˜æ–¹æ–‡ä»¶æœ‰æ›´æ¸…æ¥šçš„ç¯„ä¾‹ï¼Œå¯ä»¥åƒè€ƒ [Rules of Hooks](https://reactjs.org/docs/hooks-rules.html)
</Quote>

é‚£æˆ‘å€‘é¦–å…ˆè¦å…ˆä»‹ç´¹çš„ hook ç‚º useState

---

## useState

æˆ‘å€‘éƒ½çŸ¥é“ React è—‰ç”± state å’Œ props çš„æ›´æ–°ä¾†è§¸ç™¼re-renderï¼Œä½†æ˜¯å¦‚æœæˆ‘å€‘æƒ³åœ¨ function component ä¸­ä½¿ç”¨ state å¾—è©²æ€éº¼åšå‘¢ï¼Ÿ

éå»æˆ‘å€‘åœ¨ React ä¸­ä½¿ç”¨ class çš„è©±æœƒé€™æ¨£æ‰“

```javascript
class CounterClass extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      count: 0
    };
  }
  render() {
    return (
      <>
        <p>Count: {this.state.count}</p>
        <button onClick={() => this.setState({ count: this.state.count + 1 })}>
          Add
        </button>
      </>
    );
  }
}
```

é€™æ™‚å€™å†æ›åˆ° function component ä¸­ï¼Œæˆ‘å€‘å¯ä»¥é€™æ¨£æ‰“

```javascript
const CounterFC = () => {
  const [count, setCount] = useState(0) // <-- æˆ‘å€‘å¯ä»¥åœ¨ useState ä¸­æŒ‡å®šåˆå§‹å€¼
  return (
    <>
      <p>Count: {count}</p>
      <button onClick={() => setCount(prevCount => prevCount + 1)}>
        Add
      </button>
    </>
  )
}
```

<Quote
    type={'info'}
>
    ### æ˜¯ä¸æ˜¯å°‘äº†å¾ˆå¤šï¼Œçœ‹èµ·ä¾†ä¹Ÿç›´è§€ä¸€äº›äº†
    - è€Œä¸”æˆ‘å€‘ä¹Ÿä¸å¿…å¯«åˆ° `this` é€™å€‹å¾ˆå¸¸è®“åˆå­¸ Javascript çš„äººæ„Ÿåˆ°å›°æƒ‘çš„æ±è¥¿
</Quote>

 - é€™è£¡å¯ä»¥çœ‹åˆ°æˆ‘æ‰“çš„æ˜¯ `setCount(prevCount => prevCount + 1)` è€Œä¸æ˜¯ `setCount(count + 1)`

 - ä»–å€‘çš„å·®åˆ¥åœ¨æ–¼ï¼Œå¦‚æœæˆ‘åœ¨ä¸€å€‹ function ä¸­æ‰“å…©å€‹ `setCount(count + 1)` çš„è©±æœ€å¾ŒåªæœƒåŠ ä¸€æ¬¡ï¼Œè€Œä¸æœƒåŠ å…©æ¬¡

 - å¦‚æœæˆ‘åœ¨ä¸€å€‹ function ä¸­æ‰“å…©å€‹ `setCount(prevCount => prevCount + 1)` å‰‡å¯ä»¥åŠ å…©æ¬¡

---

## useEffect

React çš„ useEffect å¯ä»¥åœ¨åŸ·è¡Œä¸€å€‹ functionï¼Œé€™å€‹ function æœƒåœ¨ component render å®Œæˆä¹‹å¾ŒåŸ·è¡Œã€‚

é€šå¸¸æˆ‘å€‘æœƒåœ¨ useEffect ä¸­åŸ·è¡Œ side effectã€‚

### Side Effect

Side Effect æ˜¯æŒ‡ä¸€å€‹ function åšäº†è·Ÿæœ¬èº«é‹ç®—è¿”å›å€¼æ²’æœ‰é—œä¿‚çš„äº‹ï¼Œå¯èƒ½ä¿®æ”¹æŸå€‹å…¨åŸŸè®Šæ•¸ï¼Œæˆ–æ˜¯å‚³å…¥åƒæ•¸çš„å€¼ï¼Œå…¶ä¸­åŸ·è¡Œ `console.log()` ä¹Ÿæ˜¯ä¸€ç¨® side effectã€‚

<Quote
    type={'info'}
>
    åœ¨ React ä¸­å¸¸è¦‹çš„ side effect:
    - åŸ·è¡Œ console.log()
    - fetch data
    - è¨­å®š subscription
    - å‹•æ”¹è®Š React component ä¸­çš„ DOMã€‚
</Quote>
---

å†å›åˆ°å‰›å‰›æ‰€è¬›çš„ useEffect:

<Quote
    type={'info'}
>
    - åœ¨ React class ç”Ÿå‘½é€±æœŸä¸­ï¼Œ componentDidMountã€componentDidUpdateã€componentWillUnmount å…¶å¯¦å¯ä»¥è¢«è¦–ç‚º useEffect çš„çµ„åˆã€‚
</Quote>

```javascript
const ListExample = () => {
  const [data, setData] = useState([])
  const fetchData = async () => {
    const response = await fetch(REST_API);
    const json = await response.json();
    setData(json);
  }
  useEffect(() => {
    fetchData()
  }, []); // Only run the effect once (on mount), after that it will be skipped.
  return (
    <>
      {
        data.length === 0 && <p>LOADING...</p>
      }
      {
        data.length !== 0 && data.map((item) => (
          <p key={item.id}>{item.data}</p>
        ))
      }
    </>
  )
}
```

é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œæˆ‘å€‘åœ¨ ListExample é€™å€‹ function component render å®Œæˆå¾Œï¼Œä¸¦å» call API ä¾†å–å¾—è³‡æ–™ã€‚

ç•¶ä¸­æˆ‘å€‘çœ‹åˆ° useEffect å¾Œæ®µçš„ç¬¬äºŒå€‹åƒæ•¸æ˜¯ä¸€å€‹ arrayï¼Œåœ¨é€™ç•¶ä¸­æˆ‘å€‘å¯ä»¥è¨­ç½®ä¾è³´é …ï¼Œå…¶ä¸­çš„å€¼è‹¥æ”¹è®Šï¼Œå°±æœƒé‡æ–°åŸ·è¡Œ useEffectã€‚

å¦‚æœæˆ‘å€‘æŠŠé€™å€‹ array æ”¹æˆ `[]`ï¼Œé‚£éº¼å°±æœƒè®“ useEffect åªæœƒåŸ·è¡Œä¸€æ¬¡ï¼Œè€Œä¸æœƒé‡æ–°åŸ·è¡Œã€‚

```javascript
useEffect(() => {
  fetchData(pageNum)
}, [pageNum]);
```

å‡å¦‚æˆ‘å€‘è¦ä¸åŒçš„ page å–å¾—ä¸åŒçš„è³‡æ–™ï¼Œå°±å¯ä»¥åœ¨é€™è£¡æ”¹è®Š pageNum çš„å€¼ï¼Œç•¶ pageNum æ”¹è®Šå¾Œï¼Œå°±æœƒé‡æ–°åŸ·è¡Œ useEffect ä¸­çš„ fetchDataã€‚

<Quote
    type={'warning'}
>
    - é€™è£¡è¦æ³¨æ„æˆ‘å€‘çš„ä¾è³´é …ï¼Œæ˜¯ä¸æœƒè¨­ç½® array æˆ– object çš„ã€‚
    - åœ¨ Javascript ä¸­å…©å€‹ object æˆ– array å°±ç®—è£¡é¢çš„å€¼ä¸€æ¨£ï¼Œä¹Ÿæœƒè¢«è¦–ç‚ºä¸åŒçš„ã€‚
    - `[ 'a', 'b' ] === [ 'a', 'b' ]` æœƒå›å‚³ `false`ã€‚
    - é€™æ¨£æœƒå°è‡´ React ä¸èƒ½æ­£å¸¸çš„åŸ·è¡Œ useEffectã€‚
</Quote>
 - æˆ‘å€‘é€šå¸¸æœƒä»¥ object ä¸­çš„å€¼ä¾†ä½œç‚ºä¾è³´é …ã€‚

<Code
    type={'success'}
    text={'å»ºè­°é€™æ¨£å¯«'}
>
    ```javascript
    useEffect(() => {
      fetchDataById(data.id)
    }, [data.id]);
    ```
</Code>
---

æœ€å¾Œæˆ‘å€‘ä¾†çœ‹å¦‚ä½•é é˜² infinite loopã€‚

ä¸éæœ€é‡è¦çš„æ˜¯æˆ‘å€‘è¦å…ˆäº†è§£ç‚ºç”šéº¼æœƒè§¸ç™¼ infinite loopã€‚

## Why Infinite Loop?

æˆ‘å€‘åœ¨å¯« `useState` æ™‚ï¼Œ `setCount(count + 1)` ç•¶ä¸­çš„ state ä¸€æ”¹è®Šå°±æœƒè§¸ç™¼ä¸€æ¬¡ renderï¼Œé€™æ™‚å€™æ•´å€‹ component éƒ½æœƒé‡æ–°åŸ·è¡Œä¸€æ¬¡ã€‚

é‚£é€™æ™‚å€™å°±æœƒå‡ºç¾ä¸€ç¨®å¯«æ³•ï¼Œä¹Ÿæ˜¯è¨±å¤šæ–°æ‰‹æœƒçŠ¯çš„éŒ¯èª¤ï¼Œæˆ‘å€‘å…ˆçœ‹çœ‹ä»¥ä¸‹çš„å¯«æ³•ã€‚

<Code
    type={'error'}
    text={'é€™æ˜¯éŒ¯çš„ - infinite loop'}
>
    ```javascript
    const CounterFC = () => {
      const [count, setCount] = useState(0)
      setCount(count + 1) // infinite loop
      return (
        <>
          <p>Count: {count}</p>
        </>
      )
    }
    ```
</Code>
å¦‚æœæˆ‘å€‘ç›´æ¥åœ¨æ¸²æŸ“æ–¹æ³•æˆ–åŠŸèƒ½çµ„ä»¶çš„ä¸»é«”å…§æ›´æ–°ç‹€æ…‹ï¼Œå°±æœƒå°è‡´ infinite loopã€‚

<Quote
    type={'error'}
>
    - state updates â†’ triggers re-render â†’ state updates â†’ triggers re-render â†’ â€¦ â†’ infinite loop
</Quote>
---

## How to Prevent Infinite Loop?

<Quote
    type={'info'}
>
    - æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `useEffect` ä¾†é˜²æ­¢ infinite loopï¼Œè—‰ç”± sideEffect çš„æ–¹å¼ä¾†æ›´æ–° stateã€‚
</Quote>
æˆ‘å€‘ç¨å¾®ä¿®æ­£ä¸Šé¢çš„ç¯„ä¾‹

<Code
    type={'info'}
    text={'è—‰ç”± onMount ä¾†è§¸ç™¼'}
>
    ```javascript
    const CounterFC = () => {
      const [count, setCount] = useState(0)
      useEffect(() => {
        setCount(count + 1)
      }, [])
      return (
        <>
          <p>Count: {count}</p>
        </>
      )
    }
    ```
</Code>
### ç¬¬äºŒç¨®éŒ¯èª¤

<Code
    type={'error'}
    text={'é€™æ˜¯éŒ¯çš„ - infinite loop'}
>
    ```javascript
    const CounterFC = () => {
      const [count, setCount] = useState(0)
      useEffect(() => {
        setCount(count + 1) // infinite loop
      }, [count])
      return (
        <>
          <p>Count: {count}</p>
        </>
      )
    }
    ```
</Code>
å¤§å®¶æ‡‰è©²çœ‹åˆ°é€™å¾ˆæ˜é¡¯æœƒè§¸ç™¼ infinite loopã€‚

å› ç‚ºç•¶æˆ‘å€‘åœ¨æ›´æ–° count çš„åŒæ™‚ï¼Œåˆæœƒè§¸ç™¼ setCountï¼Œé€™æ¨£å°±æœƒè§¸ç™¼ infinite loopã€‚

<Quote
    type={'error'}
>
    - state updates â†’ triggers re-render â†’ state updates â†’ triggers re-render â†’ â€¦ â†’ infinite loop
</Quote>
<Quote
    type={'info'}
>
    - æˆ‘å€‘å¯ä»¥è—‰ç”± event ä¾†è§¸ç™¼ã€‚
</Quote>
<Code
    type={'info'}
    text={'è—‰ç”± onClick ä¾†è§¸ç™¼'}
>
    ```javascript
    const CounterFC = () => {
      const [count, setCount] = useState(0)
      return (
        <>
          <p>Count: {count}</p>
          <button onClick={() => setCount(1)}>Add</button>
        </>
      )
    }
    ```
</Code>
<Quote
    type={'warning'}
>
    - æˆ‘å€‘ä¸€å®šè¦åœ¨ `onClick` ä¸­è¨­ç½®ä¸€å€‹ functionã€‚
    - è€Œä¸æ˜¯ function çš„åŸ·è¡Œéç¨‹ï¼Œä¸ç„¶é€™ä¹Ÿæœƒè§¸ç™¼ infinite loopã€‚
</Quote>
### ç¬¬ä¸‰ç¨®éŒ¯èª¤

<Code
    type={'error'}
    text={'é€™æ˜¯éŒ¯çš„ - infinite loop'}
>
    ```javascript
    const CounterFC = () => {
      const [count, setCount] = useState(0)
      return (
        <>
          <p>Count: {count}</p>
          <button
            // infinite loop
            onClick={setCount(1)}>
            Add
          </button>
        </>
      )
    }
    ```
</Code>
<Quote
    type={'error'}
>
    - state updates â†’ triggers re-render â†’ state updates â†’ triggers re-render â†’ â€¦ â†’ infinite loop
</Quote>
**ä»¥ä¸Šä¸‰ç¨®ç‹€æ³æ˜¯æˆ‘æ•´ç†å‡ºä¾†æ¯”è¼ƒå¸¸è§¸ç™¼ infinite loop çš„ç‹€æ³ã€‚**

**ä¹Ÿæ˜¯éå»è‡ªå·±æœ‰é‡éçš„å‘ï¼Œæƒ³åˆ†äº«çµ¦å¤§å®¶ã€‚**

---

## ç¸½çµ ğŸ‰

åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œä¸»è¦å’Œå¤§å®¶èªªæ˜äº†å››å¤§é»ã€‚

 - Hook çš„è¦å‰‡ï¼ŒåŠæ‰€å¸¶ä¾†çš„æ–¹ä¾¿æ€§
 - useState çš„ä½¿ç”¨æ–¹å¼
 - useEffect çš„ä½¿ç”¨æ–¹å¼
 - å¦‚ä½•é é˜² infinite loop

**ä¹Ÿæ„Ÿè¬å¤§å®¶æœ‰è€å¿ƒçš„æŠŠé€™ç¯‡æ–‡ç« çœ‹å®Œ**

å› ç‚ºç¬¬ä¸€æ¬¡å¯«é€™ç¨®æŠ€è¡“æ–‡ç« ï¼Œç•¶ä¸­è‹¥æœ‰èªªéŒ¯çš„æœƒç›¡é€Ÿä¿®æ­£ï¼Œæœªä¾†ä¹ŸæœƒæŒçºŒå’Œå¤§å®¶åˆ†äº«ä¸åŒå±¤é¢çš„æŠ€è¡“~

è‹¥ä½ è¦ºå¾—é€™ç¯‡å°ä½ æœ‰å¹«åŠ©ï¼Œä¹Ÿå¯ä»¥åˆ†äº«çµ¦å…¶ä»–äººï¼Œè®“å¤§å®¶ä¸€èµ·å­¸ç¿’ã€‚

åº•ä¸‹ä¹Ÿå¯ä»¥çµ¦äºˆç•™è¨€åŠå›é¥‹å–”~~
